<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: src/pages/StimulationPlanning/ContactSelection.jsx</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="fallback-light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-DatabaseLookup.html">DatabaseLookup</a></div><div class="sidebar-section-children"><a href="module-Designation.html">Designation</a></div><div class="sidebar-section-children"><a href="module-Resection.html">Resection</a></div><div class="sidebar-section-children"><a href="module-UserDocumentation.html">UserDocumentation</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer.html">nifti_viewer</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer_matlab_functions.html">nifti_viewer/matlab_functions</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-nifti_viewer-FILE.html">FILE</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#Dropdown">Dropdown</a></div><div class="sidebar-section-children"><a href="global.html#HelpButton">HelpButton</a></div><div class="sidebar-section-children"><a href="global.html#Identifiers">Identifiers</a></div><div class="sidebar-section-children"><a href="global.html#Legend">Legend</a></div><div class="sidebar-section-children"><a href="global.html#LegendItem">LegendItem</a></div><div class="sidebar-section-children"><a href="global.html#generateAcronym">generateAcronym</a></div><div class="sidebar-section-children"><a href="global.html#handleFileRecord">handleFileRecord</a></div><div class="sidebar-section-children"><a href="global.html#insertRegionsAndGetIds">insertRegionsAndGetIds</a></div><div class="sidebar-section-children"><a href="global.html#mapConsecutive">mapConsecutive</a></div><div class="sidebar-section-children"><a href="global.html#parseCSVFile">parseCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#parseDesignation">parseDesignation</a></div><div class="sidebar-section-children"><a href="global.html#parseLocalization">parseLocalization</a></div><div class="sidebar-section-children"><a href="global.html#parseStimulation">parseStimulation</a></div><div class="sidebar-section-children"><a href="global.html#parseTests">parseTests</a></div><div class="sidebar-section-children"><a href="global.html#saveCSVFile">saveCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveDesignationCSVFile">saveDesignationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveLocalizationToDatabase">saveLocalizationToDatabase</a></div><div class="sidebar-section-children"><a href="global.html#saveStimulationCSVFile">saveStimulationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveTestCSVFile">saveTestCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#sendShareNotification">sendShareNotification</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">src_pages_StimulationPlanning_ContactSelection.jsx</h1></header><article><pre class="prettyprint source lang-js"><code>import { demoContactData } from "./demoData";
import React, { useState, setState, useEffect } from "react";
import { useDrag, useDrop } from "react-dnd";
import { DndProvider } from "react-dnd";
import { HTML5Backend } from "react-dnd-html5-backend";
import { Container, Button, darkColors, lightColors } from 'react-floating-action-button';
import { saveStimulationCSVFile } from "../../utils/CSVParser";
import mapConsecutive from "../../utils/MapConsecutive";
import { useError } from '../../context/ErrorContext';
import { useWarning } from '../../context/WarningContext';
import HelpButton from "../../utils/HelpButton";

const backendURL = __APP_CONFIG__.backendURL;

const ContactSelection = ({ initialData = {}, onStateChange, savedState = {}, switchContent, type = 'mapping' }) => {
    const { showError } = useError();
    const [electrodes, setElectrodes] = useState(savedState.electrodes || initialData.data || demoContactData)
    const [planningContacts, setPlanningContacts] = useState(() => {
        if (savedState.planningContacts) return savedState.planningContacts;
        const contactsData = initialData.data?.data || initialData.data;
        if (contactsData) {
            return contactsData.map(electrode => {
                return mapConsecutive(electrode.contacts, 2,
                    (contacts) => {
                        if (contacts[0].isPlanning) {
                            return contacts;
                        }
                        return null;
                    });
            })
            .flat()
            .filter(Boolean)
            .sort((a, b) => a[0].order - b[0].order);
        }
        return [];
    });
    const [areAllVisible, setAreAllVisible] = useState(savedState.areAllVisible || false);      // Boolean for if all contacts are visible
    const [submitPlanning, setSubmitPlanning] = useState(savedState.submitPlanning || false);

    const [state, setState] = useState(() => {
        if (!savedState.frequency) savedState.frequency = [];
        if (!savedState.duration) savedState.duration = [];
        if (!savedState.current) savedState.current = [];
        if (!savedState.patientId) savedState.patientId = initialData.patientId || null;

        return savedState;
    });

    // Save state changes
    useEffect(() => {
        onStateChange(state);
    }, [state]);

    useEffect(() => {
        setState((prevState) => {
            return {
                ...prevState,
                electrodes: electrodes,
                planningContacts: planningContacts,
                areAllVisible: areAllVisible,
                submitPlanning: submitPlanning,
                patientId: prevState.patientId // Ensure patientId is preserved
            }
        })
    }, [electrodes, planningContacts, areAllVisible, submitPlanning]);

    // Function to handle "drop" on planning pane. Takes contact and index, and insert the contact
    // at the index or at the end if index is not specified. If the contact exist already, this function
    // will change the contact's location to index passed (or to the end)
    const handleDropToPlanning = (contacts, index = "") => {
        setPlanningContacts((prev) => {
            if (index === "") index = prev.length;
            if (index > prev.length) index = prev.length;
            const newContacts = [...prev];

            if (prev.some((c) => c[0].id === contacts[0].id)) {
                // Move existing one
                let oldIndex = prev.indexOf(contacts);
                if (index === oldIndex + 1) return prev; // Ignore if index is one below
                newContacts.splice(index, 0, newContacts.splice(oldIndex, 1)[0]);
            } else {
                // Add new one
                newContacts.splice(index, 0, contacts);
            }

            return newContacts;
        });

        setElectrodes((prevElectrodes) => {
            return prevElectrodes.map((electrode) => {
                return {
                    ...electrode,
                    contacts: electrode.contacts.map((c) => {
                        if (c.id === contacts[0].id) {
                            return { ...c, isPlanning: true };
                        }
                        return c;
                    }),
                };
            });
        });
    };

    // Function to handle "drop" on contact list part. Simply removes contact from the list
    const handleDropBackToList = (contacts) => {
        setPlanningContacts((prev) => prev.filter((c) => c[0].id !== contacts[0].id));
        setElectrodes((prevElectrodes) => {
            return prevElectrodes.map((electrode) => {
                return {
                    ...electrode,
                    contacts: electrode.contacts.map((c) => {
                        if (c.id === contacts[0].id) {
                            return { ...c, isPlanning: false };
                        }
                        return c;
                    }),
                };
            });
        });
    };

    // Add id and such so that it can be used after making pair
    electrodes.map((electrode) => {
        electrode.contacts.map((contact, index) => {
            const contactId = `${electrode.label}${index + 1}`;
            contact.id = contactId;
            contact.index = index + 1;
            contact.electrodeLabel = electrode.label;
        })
    });

    return (
        &lt;DndProvider backend={HTML5Backend}>
            &lt;div className="flex min-h-screen p-6 space-x-6">
                &lt;ContactList electrodes={electrodes} onDrop={handleDropBackToList} onClick={handleDropToPlanning} droppedContacts={planningContacts} areAllVisible={areAllVisible} submitPlanning={submitPlanning} onStateChange={setState} savedState={state} setElectrodes={setElectrodes}/>

                &lt;PlanningPane state={state} electrodes={electrodes} contactPairs={planningContacts} onDrop={handleDropToPlanning} onDropBack={handleDropBackToList} submitFlag={submitPlanning} setSubmitFlag={setSubmitPlanning} setElectrodes={setElectrodes} onStateChange={setState} savedState={state} type={type} />
            &lt;/div>
            &lt;HelpButton
                title="Contact Stimulation Page Help"
                instructions="Click on or drag contact pairs in and out of the planning panel on the right. Select the length of time and power of the stimulation test."
            />
            &lt;Container className="">
                &lt;Button
                    tooltip="Toggle unmarked contacts"
                    styles={{backgroundColor: darkColors.lightBlue, color: lightColors.white}}
                    onClick={() => setAreAllVisible(!areAllVisible)}>
                    &lt;div>T&lt;/div>
                &lt;/Button>
            &lt;/Container>
        &lt;/DndProvider>
    );
};

// Generate list of contacts from list of electrodes
const ContactList = ({ electrodes, onDrop, onClick, droppedContacts, areAllVisible, submitPlanning, onStateChange, savedState, setElectrodes }) => {
    const [submitContact, setSubmitContact] = useState(savedState.submitContact || false);
    useEffect(() => {
        onStateChange((prevState) => {
            return {
                ...prevState,
                submitContact: submitContact
            }
        })
    }, [submitContact]);

    const [, drop] = useDrop(() => ({
        accept: "CONTACT",
        drop: (item) => onDrop(item),
        collect: (monitor) => ({
            isOver: monitor.isOver(),
        }),
    }));

    const showAvailableContacts = (electrode) => {
        if (!electrode || !electrode.contacts) return [];
        
        return mapConsecutive(electrode.contacts, 2, (contacts) => { // List for every contact pair
            if (!contacts) return null;

            // Only show contacts that haven't been dropped to planning
            const notDropped = !(droppedContacts.some((c) => c.id === contacts[0].id));

            // In default state, show pairs where at least one contact has a surgeon mark
            const bothSurgeonMarked = contacts[0].surgeonMark || contacts[1].surgeonMark;

            return (
                !(contacts[0].isPlanning) &amp;&amp; (
                    areAllVisible ? (
                        notDropped &amp;&amp; (
                            &lt;Contact key={contacts[0].id}
                                contacts={contacts}
                                onClick={() => onClick(contacts)} />
                        )
                    ) : (
                        notDropped &amp;&amp; bothSurgeonMarked &amp;&amp; (
                            &lt;Contact key={contacts[0].id}
                                contacts={contacts}
                                onClick={() => onClick(contacts)} />
                        )
                    )
                )
            );
        }).filter(Boolean); // Remove any null entries
    }

    return (
        &lt;div className="flex-1" ref={drop}>
            &lt;ul className="space-y-4">
                {electrodes.map((electrode) => ( // Vertical list for every electrode
                    &lt;li key={electrode.label} className="p-4 border rounded-lg shadow flex items-center space-x-6">
                        &lt;p className="text-xl font-semibold min-w-[50px]">{electrode.label}&lt;/p>
                        {(submitContact != submitPlanning) ? (
                            &lt;ul className="flex space-x-4">
                                {showAvailableContacts(electrode)} {/* contact */}
                            &lt;/ul>
                        ) : (
                            &lt;ul className="flex space-x-4">
                                {showAvailableContacts(electrode)}
                            &lt;/ul>
                        )}
                    &lt;/li>
                ))} {/* electrode */}
            &lt;/ul>
        &lt;/div>
    );
};

// Draggable contact in contact list
const Contact = ({ contacts, onClick }) => {
    // Handle "drag"
    const [{ isDragging }, drag] = useDrag(() => ({
        type: "CONTACT",
        item: contacts,
        collect: (monitor) => ({
            isDragging: monitor.isDragging(),
        }),
    }));

    let classes = `w-[100px] p-4 border rounded-lg shadow cursor-pointer ${
                isDragging ? "opacity-50" : "opacity-100"} `;
    if (contacts[0].mark == 1 || contacts[1].mark == 1) {
        classes += "bg-rose-300 ";
    } else if (contacts[0].mark == 2 || contacts[1].mark == 2) {
        classes += "bg-amber-300 ";
    } else {
        classes += "bg-stone-300 ";
    }
    if (contacts[0].surgeonMark &amp;&amp; contacts[1].surgeonMark) {
        classes += "border-2 border-stone-500";
    } else {
        classes += "border border-gray-300";
    }

    return (
        &lt;li ref={drag}
            className={classes}
            onClick={onClick}
            key={contacts[0].id}>
            &lt;p className="text-xl font-semibold">{contacts[0].index} - {contacts[1].index}&lt;/p>
            &lt;p className="text-sm font-semibold text-gray-500">{contacts[0].associatedLocation}&lt;/p>
            &lt;p className="text-sm font-semibold text-gray-500">{contacts[1].associatedLocation}&lt;/p>
        &lt;/li>
    );
};

// Planning pane on the right
const PlanningPane = ({ state, electrodes, contactPairs, onDrop, onDropBack, submitFlag, setSubmitFlag, setElectrodes, onStateChange, savedState, type = 'ccep' }) => {
    const { showError } = useError();
    const [hoverIndex, setHoverIndex] = useState(null);
    const [showSaveSuccess, setShowSaveSuccess] = useState(false);
    const { showWarning } = useWarning();
    const [showShareModal, setShowShareModal] = useState(false);
    const [shareEmail, setShareEmail] = useState('');
    const [isSharing, setIsSharing] = useState(false);

    let index = hoverIndex; // For synchronization between hover and drop

    // Handle "Drop" and hover
    const [{ isOver }, drop] = useDrop(() => ({
        accept: "CONTACT",
        hover: (item, monitor) => {
            if (!monitor.isOver()) return;
            const clientOffset = monitor.getClientOffset();
            if (!clientOffset) return;
            // Estimate the index based on y coordinate
            const hoverY = clientOffset.y;
            let elementSize = document.querySelector('li.planning-contact')?.clientHeight || 155;
            const newIndex = Math.max(0, Math.floor((hoverY - elementSize / 2) / elementSize));
            setHoverIndex(newIndex);
            index = newIndex;
        },
        drop: (item) => {
            onDrop(item, index);
            setHoverIndex(null);
            index = 0;
            item.isPlanning = true;
            setSubmitFlag(!submitFlag);
        },
        collect: (monitor) => ({
            isOver: monitor.isOver(),
        }),
    }));

    const handleSave = async () => {
        try {
            await exportState(state, electrodes, type, false);
            setShowSaveSuccess(true);
            setTimeout(() => setShowSaveSuccess(false), 2000);
        } catch (error) {
            if (error.name === "NetworkError" || error.message.toString().includes("NetworkError")) {
                showWarning("No internet connection. The progress is not saved on the database. Make sure to download your progress.");
            } else {
                console.error('Error saving:', error);
                showError(error.message);
            }
        }
    };

    const handleExport = () => {
        try {
            exportState(state, electrodes, type, true);
        } catch (error) {
            if (error.name === "NetworkError" || error.message.toString().includes("NetworkError")) {
                showWarning("No internet connection. The progress is not saved on the database. Make sure to download your progress.");
            } else {
                console.error('Error exporting:', error);
                showError(error.message);
            }
        }
    };

    // Get display name for stimulation type
    const getStimulationTypeDisplay = () => {
        switch(type) {
            case 'mapping':
                return 'Functional Mapping';
            case 'recreation':
                return 'Seizure Recreation';
            case 'ccep':
                return 'CCEPs';
            default:
                return 'Stimulation';
        }
    };

    /**
     * Handles opening the test selection page
     * @async
     */
    const handleOpenTestSelection = async () => {
        try {
            await handleSave();

            // First check if any test selection tabs for this patient already exist
            const tabs = JSON.parse(localStorage.getItem('tabs') || '[]');
            const existingTab = tabs.find(tab => 
                (tab.content === 'functional-test' || tab.content === 'csv-functional-test') &amp;&amp; 
                tab.state?.patientId === state.patientId
            );

            if (existingTab) {
                // Compare modified dates
                const existingModifiedDate = existingTab.state.modifiedDate;
                const stimulationModifiedDate = state.modifiedDate;

                if (existingModifiedDate > stimulationModifiedDate) {
                    // Switch to existing tab as it's newer
                    const activateEvent = new CustomEvent('setActiveTab', {
                        detail: { tabId: existingTab.id }
                    });
                    window.dispatchEvent(activateEvent);
                    return;
                } else {
                    // Close existing tab as it's older
                    const closeEvent = new CustomEvent('closeTab', {
                        detail: { tabId: existingTab.id }
                    });
                    window.dispatchEvent(closeEvent);
                }
            } else {
                // Check database for existing file
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('User not authenticated');
                    }

                    const response = await fetch(`${backendURL}/api/by-patient-test/${state.patientId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success &amp;&amp; result.exists) {
                        const dbModifiedDate = result.modifiedDate;
                        const stimulationModifiedDate = state.modifiedDate;

                        if (dbModifiedDate > stimulationModifiedDate) {
                            // Create tab from database file
                            const event = new CustomEvent('addFunctionalTestTab', {
                                detail: {
                                    fromTestSelection: true,
                                    data: result.data,
                                    state: {
                                        fileName: 'Neuropsychology',
                                        fileId: result.fileId,
                                        patientId: state.patientId,
                                        modifiedDate: result.modifiedDate
                                    }
                                }
                            });
                            window.dispatchEvent(event);
                            return;
                        }
                    }
                } catch (error) {
                    console.error('Error checking database for existing file:', error);
                    // Continue with creating new tab if database check fails
                }
            }

            // Create a new tab with the test selection data
            const event = new CustomEvent('addFunctionalTestTab', {
                detail: { 
                    data: electrodes,
                    state: {
                        patientId: state.patientId,
                        fileId: existingTab?.state?.fileId || null,
                        fileName: 'Neuropsychology',
                        creationDate: state.creationDate,
                        modifiedDate: new Date().toISOString()
                    }
                }
            });
            window.dispatchEvent(event);

        } catch (error) {
            if (error.name === "NetworkError" || error.message.toString().includes("NetworkError")) {
                showWarning("No internet connection. The progress is not saved on the database. Make sure to download your progress.");
            } else {
                console.error('Error opening test selection:', error);
                showError('Failed to open test selection. Please try again.');
            }
        }
    };

    const handleShareWithNeuropsychologist = async () => {
        if (!shareEmail) {
            showError('Please enter an email address');
            return;
        }

        setIsSharing(true);
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('No authentication token found');
            }

            console.log('Starting share process...');
            console.log('Current state:', {
                fileId: state.fileId,
                patientId: state.patientId,
                electrodes
            });

            // First save the epilepsy file
            console.log('Saving epilepsy file...');
            await handleSave();
            console.log('Epilepsy file saved successfully');

            // Now share the file
            console.log('Sharing file with neuropsychologist...');
            console.log('Request URL:', `${backendURL}/api/files/share-with-neuropsychologist`);
            console.log('Request headers:', {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            });
            console.log('Request body:', {
                fileId: state.fileId,
                email: shareEmail,
                testSelectionData: {
                    contacts: electrodes,
                    tests: {}
                }
            });

            const response = await fetch(`${backendURL}/api/files/share-with-neuropsychologist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    fileId: state.fileId,
                    email: shareEmail,
                    testSelectionData: {
                        contacts: electrodes,
                        tests: {}
                    }
                })
            });

            console.log('Response status:', response.status);
            console.log('Response headers:', Object.fromEntries(response.headers.entries()));
            
            // Log the raw response text first
            const responseText = await response.text();
            console.log('Raw response:', responseText);

            // Try to parse as JSON if possible
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('Parsed response:', result);
            } catch (parseError) {
                console.error('Failed to parse response as JSON:', parseError);
                throw new Error(`Invalid response format: ${responseText.substring(0, 100)}...`);
            }

            if (!response.ok) {
                throw new Error(result.error || 'Failed to share file');
            }

            if (result.success) {
                showWarning('File shared successfully with neuropsychologist');
                setShowShareModal(false);
                setShareEmail('');
            } else {
                throw new Error(result.error || 'Failed to share file');
            }
        } catch (error) {
            console.error('Error sharing file:', error);
            showError(error.message || 'Failed to share file with neuropsychologist');
        } finally {
            setIsSharing(false);
        }
    };

    return (
        &lt;div ref={drop} className={`p-4 w-1/4 border-l shadow-lg ${isOver ? "bg-gray-100" : ""}`}>
            {/* First row of buttons */}
            &lt;div className="flex space-x-2 mb-4">
                &lt;div className="relative w-1/2">
                    &lt;button
                        className={`w-full py-2 px-4 bg-green-500 text-white font-bold rounded ${
                            contactPairs.length === 0 ? "opacity-50 cursor-not-allowed" : "hover:bg-green-700 border border-green-700"
                        }`}
                        onClick={handleSave}
                        disabled={contactPairs.length === 0}
                    >
                        Save
                    &lt;/button>
                    {showSaveSuccess &amp;&amp; (
                        &lt;div className="absolute bottom-full mb-2 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-75 text-white px-3 py-1 rounded text-sm whitespace-nowrap z-50">
                            Save successful!
                        &lt;/div>
                    )}
                &lt;/div>
                &lt;button
                    className={`w-1/2 py-2 px-4 bg-sky-500 text-white font-bold rounded ${
                        contactPairs.length === 0 ? "opacity-50 cursor-not-allowed" : "hover:bg-sky-700 border border-sky-700"
                    }`}
                    onClick={handleExport}
                    disabled={contactPairs.length === 0}
                >
                    Export
                &lt;/button>
            &lt;/div>

            {/* Second row of buttons - only show for functional mapping */}
            {type === 'mapping' &amp;&amp; (
                &lt;div className="flex space-x-2 mb-4">
                    &lt;button
                        className={`flex-1 py-2 px-4 bg-blue-500 border border-blue-600 text-white font-semibold rounded transition-colors duration-200 shadow-lg ${
                            contactPairs.length === 0 ? "opacity-50 cursor-not-allowed" : "hover:bg-blue-600 cursor-pointer"
                        }`}
                        onClick={() => setShowShareModal(true)}
                        disabled={contactPairs.length === 0}>
                        Share with Neuropsychologist
                    &lt;/button>
                    &lt;button
                        className={`flex-1 py-2 px-4 bg-indigo-500 border border-indigo-600 text-white font-semibold rounded transition-colors duration-200 shadow-lg ${
                            contactPairs.length === 0 ? "opacity-50 cursor-not-allowed" : "hover:bg-indigo-600 cursor-pointer"
                        }`}
                        onClick={handleOpenTestSelection}
                        disabled={contactPairs.length === 0}>
                        Open in Neuropsychology
                    &lt;/button>
                &lt;/div>
            )}

            &lt;div className="mb-4">
                &lt;h2 className="text-xl font-semibold mb-2">Planning&lt;/h2>
                &lt;p className="text-sm text-gray-600">{getStimulationTypeDisplay()}&lt;/p>
            &lt;/div>

            {contactPairs.length === 0 ? (
                &lt;p className="text-lg text-gray-500">Drag contacts here&lt;/p>
            ) : (
                &lt;ul className="space-y-2 relative">
                    {contactPairs.map((contacts, index) => (
                        &lt;React.Fragment key={contacts[0].id}>
                            {hoverIndex === index &amp;&amp; isOver &amp;&amp; (
                                &lt;div className="h-1 bg-blue-500 w-full my-1">&lt;/div>
                            )}
                            &lt;PlanningContact contacts={contacts} onDropBack={onDropBack} onStateChange={onStateChange} savedState={savedState} setElectrodes={setElectrodes} />
                        &lt;/React.Fragment>
                    ))}
                    {hoverIndex >= contactPairs.length &amp;&amp; isOver &amp;&amp; (
                        &lt;div className="h-1 bg-blue-500 w-full my-1">&lt;/div>
                    )}
                &lt;/ul>
            )}

            {showShareModal &amp;&amp; (
                &lt;div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    &lt;div className="bg-white p-6 rounded-lg shadow-xl max-w-md w-full mx-4">
                        &lt;h2 className="text-xl font-bold mb-4">Share with Neuropsychologist&lt;/h2>
                        &lt;div className="mb-4">
                            &lt;label className="block text-sm font-medium text-gray-700 mb-1">
                                Neuropsychologist's Email
                            &lt;/label>
                            &lt;input
                                type="email"
                                value={shareEmail}
                                onChange={(e) => setShareEmail(e.target.value)}
                                className="w-full p-2 border border-gray-300 rounded-md"
                                placeholder="Enter email address"
                            />
                        &lt;/div>
                        &lt;div className="flex justify-end gap-2">
                            &lt;button
                                onClick={() => {
                                    setShowShareModal(false);
                                    setShareEmail('');
                                }}
                                className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                disabled={isSharing}
                            >
                                Cancel
                            &lt;/button>
                            &lt;button
                                onClick={handleShareWithNeuropsychologist}
                                className="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600"
                                disabled={isSharing}
                            >
                                {isSharing ? 'Sharing...' : 'Share'}
                            &lt;/button>
                        &lt;/div>
                    &lt;/div>
                &lt;/div>
            )}
        &lt;/div>
    );
};

// Draggable contact in planning pane area
const PlanningContact = ({ contacts, onDropBack, onStateChange, savedState, setElectrodes }) => {
    // To persist between tab switch and reload
    const [frequency, setFrequency] = useState(savedState.frequency?.[contacts[0].id] || contacts[0].frequency || 0);
    const [duration, setDuration] = useState(savedState.duration?.[contacts[0].id] || contacts[0].duration || 0);
    const [current, setCurrent] = useState(savedState.current?.[contacts[0].id] || contacts[0].current || 0);

    // Handle "Drag"
    const [{ isDragging }, drag] = useDrag(() => ({
        type: "CONTACT",
        item: contacts,
        collect: (monitor) => ({
            isDragging: monitor.isDragging(),
        }),
    }));

    // Update savedState when inputs change
    const updateSavedState = (field, value) => {
        onStateChange((prevState) => {
            return {
                ...prevState,
                [field]: {
                    ...prevState[field],
                    [contacts[0].id]: value,
                },
            };
        });
    };

    const updateContact = (field, value) => {
        setElectrodes((prevElectrodes) => {
            return prevElectrodes.map((electrode) => {
                return {
                    ...electrode,
                    contacts: electrode.contacts.map((c) => {
                        if (c.id === contacts[0].id) {
                            return { ...c, [field]: value };
                        }
                        return c;
                    }),
                };
            });
        });
    };

    const handleFrequencyChange = (e) => {
        const value = parseFloat(e.target.value);
        setFrequency(value);
        updateContact("frequency", value);
        updateSavedState("frequency", value);
    };

    const handleDurationChange = (e) => {
        const value = parseFloat(e.target.value);
        setDuration(value);
        updateContact("duration", value);
        updateSavedState("duration", value);
    };

    const handleCurrentChange = (e) => {
        const value = parseFloat(e.target.value);
        setCurrent(value);
        updateContact("current", value);
        updateSavedState("current", value);
    };

    let classes = `planning-contact p-2 border rounded-lg shadow cursor-pointer ${
        isDragging ? "opacity-50" : "opacity-100"} `;
    if (contacts[0].mark == 1 || contacts[1].mark == 1) {
        classes += "bg-rose-300 ";
    } else if (contacts[0].mark == 2 || contacts[1].mark == 2) {
        classes += "bg-amber-300 ";
    } else {
        classes += "bg-stone-300 ";
    }
    if (contacts[0].surgeonMark &amp;&amp; contacts[1].surgeonMark) {
        classes += "border-2 border-stone-500";
    } else {
        classes += "border border-gray-300";
    }

    return (
        &lt;li ref={drag}
            className={classes}
            key={contacts[0].id}>
            &lt;p className="text-lg font-semibold">{contacts[0].id}-{contacts[1].index}&lt;/p>
            &lt;p className="text-sm font-semibold text-gray-500">Location: {contacts[0].associatedLocation}&lt;/p>
            &lt;p className="text-sm font-semibold text-gray-500">Location: {contacts[1].associatedLocation}&lt;/p>

            &lt;div className="flex space-x-2 mt-2">
                &lt;div className="flex-1">
                    &lt;label className="block text-sm font-medium text-gray-700">Frequency (Hz)&lt;/label>
                    &lt;input
                        type="number"
                        value={frequency}
                        onChange={handleFrequencyChange}
                        className="w-full p-1 border rounded bg-white"
                    />
                &lt;/div>
                &lt;div className="flex-1">
                    &lt;label className="block text-sm font-medium text-gray-700">Duration (s)&lt;/label>
                    &lt;input
                        type="number"
                        value={duration}
                        onChange={handleDurationChange}
                        className="w-full p-1 border rounded bg-white"
                    />
                &lt;/div>
                &lt;div className="flex-1">
                    &lt;label className="block text-sm font-medium text-gray-700">Current (mA)&lt;/label>
                    &lt;input
                        type="number"
                        value={current}
                        onChange={handleCurrentChange}
                        className="w-full p-1 border rounded bg-white"
                    />
                &lt;/div>
            &lt;/div>

            &lt;button onClick={() => onDropBack(contacts)}
                    className="text-red-500 text-sm mt-2 underline" >
                Remove
            &lt;/button>
        &lt;/li>
    );
};

const exportState = async (state, electrodes, type, download = true) => {
    let planOrder = state.planningContacts.map(contacts => contacts[0].id);
    try {
        // First save to database if we have a file ID
        if (state.fileId) {
            console.log('Saving stimulation plan to database...');
            console.log('Current state:', {
                fileId: state.fileId,
                patientId: state.patientId,
                fileName: state.fileName
            });

            // Get user ID from session
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('User not authenticated. Please log in to save.');
            }
            
            try {
                // Save stimulation data to database
                console.log('Saving stimulation data with patient_id:', state.patientId);
                const response = await fetch(`${__APP_CONFIG__.backendURL}/api/save-stimulation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    },
                    body: JSON.stringify({
                        electrodes: electrodes,
                        planOrder: planOrder,
                        type: type,
                        fileId: state.fileId,
                        fileName: state.fileName,
                        creationDate: state.creationDate,
                        modifiedDate: new Date().toISOString(),
                        patientId: state.patientId
                    }),
                });

                const result = await response.json();
                console.log('Save stimulation response:', result);
                if (!result.success) {
                    console.error('Failed to save stimulation:', result.error);
                    throw error;
                }

                console.log('Stimulation saved successfully');
            } catch (error) {
                console.error('Error saving stimulation:', error);
                throw error;
            }
        }
    } catch (error) {
        console.error('Error exporting contacts:', error);
        throw error;
    } finally {
        if (download) {
            saveStimulationCSVFile(electrodes, planOrder, type, state.patientId, state.creationDate, state.modifiedDate, download, state.fileId);
        }
    }
};

export default ContactSelection;
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-DatabaseLookup.html">DatabaseLookup</a></div><div class="sidebar-section-children"><a href="module-Designation.html">Designation</a></div><div class="sidebar-section-children"><a href="module-Resection.html">Resection</a></div><div class="sidebar-section-children"><a href="module-UserDocumentation.html">UserDocumentation</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer.html">nifti_viewer</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer_matlab_functions.html">nifti_viewer/matlab_functions</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-nifti_viewer-FILE.html">FILE</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#Dropdown">Dropdown</a></div><div class="sidebar-section-children"><a href="global.html#HelpButton">HelpButton</a></div><div class="sidebar-section-children"><a href="global.html#Identifiers">Identifiers</a></div><div class="sidebar-section-children"><a href="global.html#Legend">Legend</a></div><div class="sidebar-section-children"><a href="global.html#LegendItem">LegendItem</a></div><div class="sidebar-section-children"><a href="global.html#generateAcronym">generateAcronym</a></div><div class="sidebar-section-children"><a href="global.html#handleFileRecord">handleFileRecord</a></div><div class="sidebar-section-children"><a href="global.html#insertRegionsAndGetIds">insertRegionsAndGetIds</a></div><div class="sidebar-section-children"><a href="global.html#mapConsecutive">mapConsecutive</a></div><div class="sidebar-section-children"><a href="global.html#parseCSVFile">parseCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#parseDesignation">parseDesignation</a></div><div class="sidebar-section-children"><a href="global.html#parseLocalization">parseLocalization</a></div><div class="sidebar-section-children"><a href="global.html#parseStimulation">parseStimulation</a></div><div class="sidebar-section-children"><a href="global.html#parseTests">parseTests</a></div><div class="sidebar-section-children"><a href="global.html#saveCSVFile">saveCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveDesignationCSVFile">saveDesignationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveLocalizationToDatabase">saveLocalizationToDatabase</a></div><div class="sidebar-section-children"><a href="global.html#saveStimulationCSVFile">saveStimulationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveTestCSVFile">saveTestCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#sendShareNotification">sendShareNotification</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>