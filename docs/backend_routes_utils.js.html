<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: backend/routes/utils.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="fallback-light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-DatabaseLookup.html">DatabaseLookup</a></div><div class="sidebar-section-children"><a href="module-Designation.html">Designation</a></div><div class="sidebar-section-children"><a href="module-Resection.html">Resection</a></div><div class="sidebar-section-children"><a href="module-UserDocumentation.html">UserDocumentation</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer.html">nifti_viewer</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer_matlab_functions.html">nifti_viewer/matlab_functions</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-nifti_viewer-FILE.html">FILE</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#Dropdown">Dropdown</a></div><div class="sidebar-section-children"><a href="global.html#HelpButton">HelpButton</a></div><div class="sidebar-section-children"><a href="global.html#Identifiers">Identifiers</a></div><div class="sidebar-section-children"><a href="global.html#Legend">Legend</a></div><div class="sidebar-section-children"><a href="global.html#LegendItem">LegendItem</a></div><div class="sidebar-section-children"><a href="global.html#generateAcronym">generateAcronym</a></div><div class="sidebar-section-children"><a href="global.html#handleFileRecord">handleFileRecord</a></div><div class="sidebar-section-children"><a href="global.html#insertRegionsAndGetIds">insertRegionsAndGetIds</a></div><div class="sidebar-section-children"><a href="global.html#mapConsecutive">mapConsecutive</a></div><div class="sidebar-section-children"><a href="global.html#parseCSVFile">parseCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#parseDesignation">parseDesignation</a></div><div class="sidebar-section-children"><a href="global.html#parseLocalization">parseLocalization</a></div><div class="sidebar-section-children"><a href="global.html#parseStimulation">parseStimulation</a></div><div class="sidebar-section-children"><a href="global.html#parseTests">parseTests</a></div><div class="sidebar-section-children"><a href="global.html#saveCSVFile">saveCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveDesignationCSVFile">saveDesignationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveLocalizationToDatabase">saveLocalizationToDatabase</a></div><div class="sidebar-section-children"><a href="global.html#saveStimulationCSVFile">saveStimulationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveTestCSVFile">saveTestCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#sendShareNotification">sendShareNotification</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">backend_routes_utils.js</h1></header><article><pre class="prettyprint source lang-js"><code>import dotenv from 'dotenv';
import { createClient } from '@supabase/supabase-js';
import { Resend } from 'resend';

dotenv.config();

// Supabase Client Initialization
export const supabase = createClient(process.env.SUPABASE_URL, process.env.SUPABASE_KEY);

// Initialize Resend client
const resend = new Resend(process.env.RESEND_API_KEY);

// Table names constant
export const TABLE_NAMES = [
  "cort_gm",
  "cort",
  "function",
  "function_test",
  "gm",
  "gm_function",
  "reference",
  "stimulation",
  "tag",
  "test",
  "test_tag",
  "electrode",
  "localization",
  "region_name"
];

/**
 * Handles file record management in the database.
 * Creates a new file record if it doesn't exist, or updates an existing one.
 * Also creates file assignments for new files.
 * @param {string} fileId - The unique identifier for the file
 * @param {string} fileName - The name of the file
 * @param {string} creationDate - The creation date of the file
 * @param {string} modifiedDate - The last modified date of the file
 * @param {string} token - The authorization token for the user session
 * @param {string} patientId - The ID of the patient associated with the file
 * @returns {Promise&lt;void>} - Resolves when the operation is complete, throws on error
 */
export async function handleFileRecord(fileId, fileName, creationDate, modifiedDate, token, patientId) {
  // Check if file record already exists
  const { data: existingFile } = await supabase
    .from('files')
    .select('*')
    .eq('file_id', fileId)
    .single();

  if (existingFile) {
    // Update existing file record
    const { error: fileError } = await supabase
      .from('files')
      .update({
        filename: fileName,
        modified_date: modifiedDate,
        patient_id: patientId
      })
      .eq('file_id', fileId);

    if (fileError) throw fileError;
  } else {
    // Get user ID from session
    if (!token) {
      throw new Error('No authentication token provided');
    }
    
    const { data: session } = await supabase
      .from('sessions')
      .select('user_id')
      .eq('token', token)
      .single();
      
    if (!session?.user_id) {
      throw new Error('Invalid or expired session');
    }

    // Insert new file record
    const { error: fileError } = await supabase
      .from('files')
      .insert({
        file_id: fileId,
        owner_user_id: session.user_id,
        filename: fileName,
        creation_date: creationDate,
        modified_date: modifiedDate,
        patient_id: patientId
      });

    if (fileError) throw fileError;

    // Create file assignments for the new file
    const { error: assignmentError } = await supabase
      .from('file_assignments')
      .insert({
        file_id: fileId,
        user_id: session.user_id,
        patient_id: patientId,
        role: 'owner',
        has_seen: true,
        is_completed: false,
        completed_at: null
      });

    if (assignmentError) throw assignmentError;
  }
}

/**
 * Generates an acronym from a description.
 * @param {string} description - The description to generate an acronym from.
 * @returns {string} - The generated acronym.
 */
export function generateAcronym(description) {
  return description
    .split('')
    .filter(char => char >= 'A' &amp;&amp; char &lt;= 'Z')
    .join('');
}

/**
 * Inserts new regions into the region_name table and returns a mapping of region names to their IDs.
 * @param {string[]} regions - Array of region names.
 * @returns {Object} - A mapping of region names to their IDs.
 */
export async function insertRegionsAndGetIds(regions) {
  const regionIdMap = {};

  try {
    // Fetch existing regions
    const { data: existingRegions, error: fetchError } = await supabase
      .from('region_name')
      .select('id, name');

    if (fetchError) {
      console.error('Error fetching existing regions:', fetchError);
      console.error('Error details:', JSON.stringify(fetchError));
      throw fetchError;
    }

    // Create a map of lowercase names to their database versions and IDs
    const existingNamesMap = new Map();
    existingRegions.forEach(region => {
      const lowerName = region.name.toLowerCase();
      existingNamesMap.set(lowerName, {
        id: region.id,
        name: region.name
      });
    });

    // Filter out regions that already exist (case-insensitive)
    const newRegionsSet = new Set();
    const newRegions = regions.filter(region => {
      if (!region) return false;
      const lowerRegion = region.toLowerCase();
      
      // If this region (case-insensitive) already exists
      if (existingNamesMap.has(lowerRegion)) {
        // Use the existing version from the database
        const existing = existingNamesMap.get(lowerRegion);
        regionIdMap[existing.name] = existing.id; // Only map the database version
        return false;
      }
      
      // If we haven't seen this region (case-insensitive) in this batch
      if (!newRegionsSet.has(lowerRegion)) {
        newRegionsSet.add(lowerRegion);
        return true;
      }
      
      return false;
    });

    if (newRegions.length > 0) {
      console.log(`Inserting ${newRegions.length} new regions:`, newRegions);
      
      // Insert new regions
      const { data: insertedRegions, error: insertError } = await supabase
        .from('region_name')
        .insert(newRegions.map(name => ({ name })))
        .select();

      if (insertError) {
        console.error('Error inserting new regions:', insertError);
        console.error('Error details:', JSON.stringify(insertError));
        console.error('New regions data:', newRegions);
        throw insertError;
      }

      console.log(`Successfully inserted ${insertedRegions.length} new regions`);
      
      // Add new regions to the map
      insertedRegions.forEach(region => {
        regionIdMap[region.name] = region.id;
      });
    }

    return regionIdMap;
  } catch (error) {
    console.error('Error in insertRegionsAndGetIds:', error);
    console.error('Error stack:', error.stack);
    throw error;
  }
}

/**
* Saves localization data to the database in the format of the three tables.
* @param {Object} data - The nested dictionary data from parseLocalization.
* @param {number|string} fileId - The unique file identifier
*/
export async function saveLocalizationToDatabase(data, fileId) {
 try {
   console.log(`Starting save process for file ID: ${fileId}`);
   
   // Ensure fileId is an integer
   const numericFileId = typeof fileId === 'string' ? parseInt(fileId) : fileId;
   
   if (isNaN(numericFileId)) {
     throw new Error(`Invalid file ID: ${fileId} (must be a valid number)`);
   }
   
   console.log(`Saving ${Object.keys(data).length} electrodes for file ID: ${numericFileId}`);
   console.log('Sample data structure:', JSON.stringify(Object.entries(data)[0], null, 2));
   
   // Insert into electrode table
   const electrodeData = Object.keys(data).map(label => ({
     acronym: generateAcronym(data[label].description),  // Generate acronym from description
     description: data[label].description, // Use description as electrode_desc
     contact_number: Object.keys(data[label]).filter(key => key !== 'description' &amp;&amp; key !== 'type').length, // Subtract description and type keys
     label: label,
     type: data[label].type || 'DIXI' // Include the electrode type, default to DIXI if not specified
   }));

   console.log(`Inserting ${electrodeData.length} electrodes...`);
   
   // Added detailed error checking for electrode insert
   const { data: insertedElectrodes, error: electrodeError } = await supabase
     .from('electrode')
     .insert(electrodeData)
     .select();

   if (electrodeError) {
     console.error('Error inserting electrodes:', electrodeError);
     console.error('Error details:', JSON.stringify(electrodeError));
     console.error('Sample electrode data:', JSON.stringify(electrodeData[0]));
     throw electrodeError;
   }

   console.log(`Successfully inserted ${insertedElectrodes.length} electrodes`);

   // Create a mapping of electrode labels to their database IDs
   const electrodeIdMap = {};
   insertedElectrodes.forEach(electrode => {
     electrodeIdMap[electrode.label] = electrode.id;
   });

   console.log('Electrode ID mapping:', electrodeIdMap);

   // Collect all unique regions from the data
   const uniqueRegions = new Set();
   Object.values(data).forEach(contacts => {
     Object.values(contacts).forEach(contactData => {
       if (typeof contactData === 'object' &amp;&amp; contactData.associatedLocation) {
         if (contactData.associatedLocation === 'GM/GM') {
           const [desc1, desc2] = contactData.contactDescription.split('+');
           uniqueRegions.add(desc1);
           uniqueRegions.add(desc2);
         }
         else if (contactData.associatedLocation === 'GM' || contactData.associatedLocation === 'GM/WM' || contactData.associatedLocation === 'WM' || contactData.associatedLocation === 'OOB') {
           uniqueRegions.add(contactData.contactDescription);
         }
       }
     });
   });

   console.log(`Found ${uniqueRegions.size} unique regions`);

   // Insert new regions and get a mapping of region names to IDs
   const regionIdMap = await insertRegionsAndGetIds(Array.from(uniqueRegions));
   
   console.log('Region ID mapping:', regionIdMap);

   // Get the highest existing ID in the localization table
   const { data: maxIdData, error: maxIdError } = await supabase
     .from('localization')
     .select('id')
     .order('id', { ascending: false })
     .limit(1);

   if (maxIdError) {
     console.error('Error getting max ID:', maxIdError);
     console.error('Error details:', JSON.stringify(maxIdError));
     throw maxIdError;
   }

   let nextId = maxIdData.length > 0 ? maxIdData[0].id + 1 : 1;
   console.log(`Starting localization IDs from ${nextId}`);

   // Insert into localization table with file_id
   const localizationData = [];
   console.log('DEBUG: Starting to build localization records from data structure:');
   console.log('DEBUG: Electrode count:', Object.keys(data).length);
   console.log('DEBUG: Sample electrode data:', JSON.stringify(Object.entries(data)[0], null, 2));
   
   let skippedDescriptionCount = 0;
   let skippedNonObjectCount = 0;
   let skippedNoLocationCount = 0;
   let processedContactCount = 0;
   
   Object.entries(data).forEach(([label, contacts]) => {
     console.log(`DEBUG: Processing electrode "${label}" with ${Object.keys(contacts).length} keys`);
     console.log(`DEBUG: Contact keys:`, Object.keys(contacts));
     
     Object.entries(contacts).forEach(([contactNumber, contactData]) => {
       console.log(`DEBUG: Processing contact "${contactNumber}" for electrode "${label}"`);
       
       if (contactNumber === 'description') {
         console.log(`DEBUG: Skipping "description" key`);
         skippedDescriptionCount++;
         return; // Skip the description key
       }
       
       if (typeof contactData !== 'object') {
         console.log(`DEBUG: Skipping non-object contactData:`, contactData);
         skippedNonObjectCount++;
         return; // Skip invalid entries
       }
       
       if (!contactData.associatedLocation || contactData.associatedLocation === '') {
         console.log(`DEBUG: Setting default 'WM' location for contact without associatedLocation: ${label}/${contactNumber}`);
         console.log(`DEBUG: Original contactData:`, contactData);
         // Instead of skipping, assign default 'WM' as associatedLocation
         contactData.associatedLocation = 'WM';
         
         // If there's no contactDescription either, set a default value
         if (!contactData.contactDescription || contactData.contactDescription === '') {
           contactData.contactDescription = 'Unknown';
         }
       }
       
       processedContactCount++;
       console.log(`DEBUG: Valid contact found - ${label}/${contactNumber}: ${contactData.associatedLocation}`);
       
       const { contactDescription, associatedLocation } = contactData;
       
       if (!electrodeIdMap[label]) {
         console.error(`DEBUG: ERROR - No electrode ID found for label "${label}"`);
         console.log('DEBUG: Available electrode IDs:', electrodeIdMap);
         return; // Skip if no electrode ID found
       }
       
       // Handle GM/GM case: Split into two entries
       if (associatedLocation === 'GM/GM') {
         const [desc1, desc2] = contactDescription.split('+');
         
         if (!regionIdMap[desc1]) {
           console.error(`DEBUG: ERROR - No region ID found for "${desc1}"`);
           console.log('DEBUG: Available region IDs:', regionIdMap);
           return;
         }
         
         if (!regionIdMap[desc2]) {
           console.error(`DEBUG: ERROR - No region ID found for "${desc2}"`);
           console.log('DEBUG: Available region IDs:', regionIdMap);
           return;
         }
         
         console.log(`DEBUG: Adding two GM/GM records for ${label}/${contactNumber} (${desc1}, ${desc2})`);
         
         localizationData.push(
           {
             id: nextId++,
             electrode_id: electrodeIdMap[label],
             contact: contactNumber,
             tissue_type: 'GM',
             region_id: regionIdMap[desc1], // Use region ID from the map
             file_id: numericFileId // Add file ID to localization record
           },
           {
             id: nextId++,
             electrode_id: electrodeIdMap[label],
             contact: contactNumber,
             tissue_type: 'GM',
             region_id: regionIdMap[desc2], // Use region ID from the map
             file_id: numericFileId // Add file ID to localization record
           }
         );
       } else {
         if (!regionIdMap[contactDescription]) {
           console.error(`DEBUG: ERROR - No region ID found for "${contactDescription}"`);
           console.log('DEBUG: Available region IDs:', regionIdMap);
           return;
         }
         
         console.log(`DEBUG: Adding record for ${label}/${contactNumber} (${associatedLocation}/${contactDescription})`);
         
         localizationData.push({
           id: nextId++,
           electrode_id: electrodeIdMap[label],
           contact: contactNumber,
           tissue_type: associatedLocation,
           region_id: regionIdMap[contactDescription], // Use region ID from the map
           file_id: numericFileId // Add file ID to localization record
         });
       }
     });
   });
   
   console.log('DEBUG: Localization data build summary:');
   console.log(`DEBUG: - Skipped description keys: ${skippedDescriptionCount}`);
   console.log(`DEBUG: - Skipped non-object data: ${skippedNonObjectCount}`);
   console.log(`DEBUG: - Skipped no location data: ${skippedNoLocationCount}`);
   console.log(`DEBUG: - Processed valid contacts: ${processedContactCount}`);
   console.log(`DEBUG: - Final record count: ${localizationData.length}`);

   if (localizationData.length === 0) {
     console.warn('No localization data to insert');
     
     // Remove the test insertion that's likely causing errors
     // Just log a warning instead
     console.log('DEBUG: No localization data to save for this file');
     return;
   }

   console.log(`Inserting ${localizationData.length} localization records with file_id: ${numericFileId}`);
   console.log('Sample localization record:', JSON.stringify(localizationData[0], null, 2));
   
   // Try inserting in smaller batches to identify problem records
   try {
     // Remove the single test record insertion - this could be causing the error
     
     // Proceed with full batch insertion directly
     console.log('Proceeding with batch insertion');
     
     const { data: insertedRecords, error: localizationError } = await supabase
       .from('localization')
       .insert(localizationData)
       .select();

     if (localizationError) {
       console.error('Error inserting localization records:', localizationError);
       console.error('Error details:', JSON.stringify(localizationError));
       console.error('Data sample:', JSON.stringify(localizationData.slice(0, 3)));
       
       // Check the table structure to help diagnose
       const { data: tableInfo, error: infoError } = await supabase
         .from('localization')
         .select('*')
         .limit(1);
         
       if (infoError) {
         console.error('Error getting table structure:', infoError);
       } else {
         console.log('Existing table structure sample:', tableInfo);
       }
       
       throw localizationError;
     }

     console.log(`Successfully inserted ${localizationData.length} localization records`);
     
   } catch (batchError) {
     console.error('Batch insertion failed:', batchError);
     
     // Try inserting records one by one to identify problematic records
     console.log('Attempting record-by-record insertion to identify problem...');
     
     for (let i = 0; i &lt; localizationData.length; i++) {
       try {
         const { error: singleError } = await supabase
           .from('localization')
           .insert([localizationData[i]])
           .select();
           
         if (singleError) {
           console.error(`Error at record ${i}:`, singleError);
           console.error('Problematic record:', JSON.stringify(localizationData[i], null, 2));
         }
       } catch (singleRecordError) {
         console.error(`Exception at record ${i}:`, singleRecordError);
       }
     }
     
     // Re-throw the original error
     throw batchError;
   }
   
   // Verify records were saved by counting
   const { count, error: countError } = await supabase
     .from('localization')
     .select('*', { count: 'exact', head: true })
     .eq('file_id', numericFileId);
     
   if (countError) {
     console.warn('Error verifying saved records:', countError);
   } else {
     console.log(`Verification: Found ${count} records with file_id ${numericFileId}`);
     if (count === 0) {
       console.error('CRITICAL: Records appear to have been saved but count is 0');
     }
   }

   return {
     electrodeCount: insertedElectrodes.length,
     localizationCount: localizationData.length,
     fileId: numericFileId
   };
 } catch (error) {
   console.error("Error saving data to the database:", error);
   console.error("Error stack:", error.stack);
   
   // Check database connection
   try {
     const { data, error: pingError } = await supabase
       .from('localization')
       .select('count(*)', { count: 'exact', head: true });
       
     if (pingError) {
       console.error('Database connection issue:', pingError);
     } else {
       console.log('Database connection is working');
     }
   } catch (pingError) {
     console.error('Failed to ping database:', pingError);
   }
   
   throw error; // Re-throw to propagate to the API endpoint handler
 }
}

/**
 * Sends an email notification when a file is shared.
 * @param {string} recipientEmail - The email address of the recipient
 * @param {string} senderName - The name of the user sharing the file
 * @param {string} fileType - The type of file being shared
 * @param {string} patientId - The ID of the patient
 * @param {string} creationDate - The creation date of the file
 * @returns {Promise&lt;Object>} - The response from the email service
 */
export async function sendShareNotification(recipientEmail, senderName, fileType, patientId, creationDate) {
    try {
        const shortPatientId = patientId.substring(0, 3).toUpperCase();
        const formattedDate = new Date(creationDate).toLocaleDateString('en-US', {
            month: '2-digit',
            day: '2-digit',
            year: '2-digit'
        });

        const { data, error } = await resend.emails.send({
            from: 'Wirecracker &lt;send@wirecracker.com>',
            to: recipientEmail,
            subject: `Wirecracker: ${fileType} shared with you`,
            html: `
                &lt;p>${senderName} has shared a ${fileType} with you for patient ${shortPatientId}-${formattedDate}.&lt;/p>
                &lt;p>Please log into &lt;a href="https://wirecracker.com">wirecracker.com&lt;/a> to review the files.&lt;/p>
            `
        });

        if (error) {
            console.error('Error sending email:', error);
            throw error;
        }

        return data;
    } catch (error) {
        console.error('Failed to send share notification email:', error);
        throw error;
    }
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-modules"><div>Modules</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-DatabaseLookup.html">DatabaseLookup</a></div><div class="sidebar-section-children"><a href="module-Designation.html">Designation</a></div><div class="sidebar-section-children"><a href="module-Resection.html">Resection</a></div><div class="sidebar-section-children"><a href="module-UserDocumentation.html">UserDocumentation</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer.html">nifti_viewer</a></div><div class="sidebar-section-children"><a href="module-nifti_viewer_matlab_functions.html">nifti_viewer/matlab_functions</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="module-nifti_viewer-FILE.html">FILE</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#Dropdown">Dropdown</a></div><div class="sidebar-section-children"><a href="global.html#HelpButton">HelpButton</a></div><div class="sidebar-section-children"><a href="global.html#Identifiers">Identifiers</a></div><div class="sidebar-section-children"><a href="global.html#Legend">Legend</a></div><div class="sidebar-section-children"><a href="global.html#LegendItem">LegendItem</a></div><div class="sidebar-section-children"><a href="global.html#generateAcronym">generateAcronym</a></div><div class="sidebar-section-children"><a href="global.html#handleFileRecord">handleFileRecord</a></div><div class="sidebar-section-children"><a href="global.html#insertRegionsAndGetIds">insertRegionsAndGetIds</a></div><div class="sidebar-section-children"><a href="global.html#mapConsecutive">mapConsecutive</a></div><div class="sidebar-section-children"><a href="global.html#parseCSVFile">parseCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#parseDesignation">parseDesignation</a></div><div class="sidebar-section-children"><a href="global.html#parseLocalization">parseLocalization</a></div><div class="sidebar-section-children"><a href="global.html#parseStimulation">parseStimulation</a></div><div class="sidebar-section-children"><a href="global.html#parseTests">parseTests</a></div><div class="sidebar-section-children"><a href="global.html#saveCSVFile">saveCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveDesignationCSVFile">saveDesignationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveLocalizationToDatabase">saveLocalizationToDatabase</a></div><div class="sidebar-section-children"><a href="global.html#saveStimulationCSVFile">saveStimulationCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#saveTestCSVFile">saveTestCSVFile</a></div><div class="sidebar-section-children"><a href="global.html#sendShareNotification">sendShareNotification</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>